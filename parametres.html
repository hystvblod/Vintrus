<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="settings.title">Paramètres</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style/main.css" />
  <style>
    html, body {
      height: auto !important;
      min-height: 100vh;
      overflow-y: auto !important;
    }
    body {
      margin: 0;
      font-family: 'Quicksand', Arial, sans-serif;
      background: radial-gradient(ellipse at 60% 40%, #7061e8 0%, #5db9e3 55%, #483070 100%);
      color: #fff;
    }
    .main-content {
      display: flex;
      flex-direction: column;
      width: 100vw;
      max-width: 430px;
      box-sizing: border-box;
      align-items: center;
      justify-content: flex-start;
      margin: 0 auto;
      min-height: unset !important;
      height: auto !important;
    }
    .top-bar {
      width: 100%;
      max-width: 430px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      padding: 10px 10px 0 10px;
      position: relative;
      z-index: 10;
      background: transparent;
    }
    .top-bar-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      gap: 8px;
    }
    .btn-back {
      background: none;
      border: none;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%; padding: 4px;
      cursor: pointer;
      width: 42px; height: 42px;
      transition: background 0.15s;
    }
    .btn-back img { width: 28px; height: 28px; filter: drop-shadow(0 1px 2px #0005);}
    .main-title {
      flex: 1;
      font-size: 2em; font-weight: 900;
      color: #fff;
      letter-spacing: 2px; line-height: 1.1;
      text-align: center;
      white-space: pre-line;
      word-break: break-word;
      user-select: none;
      text-shadow: 0 3px 16px #2e6ead44, 0 1px 1px #fff7;
    }
    .profile-row {
      display: flex;
      flex-direction: row;
      gap: 8px;
    }
    .btn-icon img { width: 27px; height: 27px; }
    .param-container {
      display: flex; flex-direction: column; align-items: center;
      justify-content: flex-start;
      padding-top: 2em; gap: 2em;
      width: 100%;
      max-width: 430px;
      margin: 0 auto;
    }
    .param-group {
      background: rgba(255,255,255,0.1);
      padding: 1.2em 1.5em;
      border-radius: 1.5em;
      box-shadow: 0 2px 10px #0002;
      width: 90%; max-width: 400px;
    }
    label { font-weight: 800; font-size: 1.1em; display: block; margin-bottom: 0.6em; }
    .lang-select {
      display: flex; flex-wrap: wrap; gap: 0.7em; justify-content: center; margin-top: 0.5em;
    }
    .lang-option {
      display: flex; align-items: center; gap: 0.5em;
      padding: 0.35em 0.85em; border-radius: 1em;
      background: #e6f6ea; color: #156c31; border: none; font-weight: 700;
      cursor: pointer; box-shadow: 0 2px 8px #a2dcd220;
      transition: background 0.13s, transform 0.13s;
      font-size: 1.08em;
    }
    .lang-option.selected {
      background: linear-gradient(90deg,#70dcff 0%,#b2ff9d 100%);
      color: #0e4b26; transform: scale(1.06);
    }
    .flag { width: 22px; height: 16px; }
    .switch {
      display: flex; align-items: center; gap: 0.8em; margin-top: 0.7em;
    }
    input[type="checkbox"] {
      width: 24px; height: 24px;
      accent-color: #70dcff;
    }
    button.return-btn {
      background: none; border: 2px dashed #b8ffdb88; color: #fff;
      border-radius: 1.3em; padding: 0.6em 1.4em; font-size: 1em;
      font-weight: 700; cursor: pointer; margin-top: 1em;
    }
    button.return-btn:hover { background: rgba(255, 255, 255, 0.1); }
    .music-btn-img { width: 32px; height: 32px; vertical-align: middle;}
    @media (max-width:480px) {
      .main-content, .top-bar { max-width: 100vw; }
      .top-bar { padding: 4px 3px 0 3px; max-width: 99vw; }
      .main-title { font-size: 1.4em; }
      .btn-back { width: 32px; height: 32px; }
      .btn-back img, .btn-icon img { width: 20px; height: 20px; }
    }
  </style>
</head>
<body>
  <div class="main-content">
    <div class="top-bar">
      <div class="top-bar-row">
        <!-- BTN RETOUR : bouton et pas lien -->
        <button class="btn-back" id="btn-back" title="Retour" aria-label="Retour">
          <img src="assets/icons/arrow_back.svg" alt="Retour">
        </button>
        <span class="main-title" data-i18n="settings.title">Paramètres</span>
        <div class="profile-row">
          <!-- BTN PROFIL : vrai lien -->
          <a href="profil.html" class="btn-icon" id="btn-profile" title="Profil">
            <img src="assets/icons/user.svg" alt="Profil">
          </a>
        </div>
      </div>
    </div>

    <div class="param-container">
      <!-- Sélection langue -->
      <div class="param-group">
        <label data-i18n="settings.language.label">Langue de l'interface :</label>
        <div id="langue-select" class="lang-select"></div>
      </div>
      <!-- Vibrations -->
      <div class="param-group">
        <label data-i18n="settings.vibrate.label">Vibrations :</label>
        <div class="switch">
          <input type="checkbox" id="vibrate-toggle">
          <span id="vibrate-label" data-i18n="settings.vibrate.on">Activées</span>
        </div>
      </div>
      <!-- Publicités -->
      <div class="param-group">
        <label data-i18n="settings.ads.label">Publicités personnalisées :</label>
        <div class="switch">
          <input type="checkbox" id="ads-toggle">
          <span id="ads-label" data-i18n="settings.ads.on">Activées</span>
        </div>
      </div>
      <!-- Pièce fantôme -->
      <div class="param-group">
        <label data-i18n="settings.ghost.label">Afficher la pièce fantôme :</label>
        <div class="switch">
          <input type="checkbox" id="ghost-toggle">
          <span id="ghost-label" data-i18n="settings.ghost.on">Activée</span>
        </div>
      </div>
      <!-- Musique -->
      <div class="param-group">
        <label>Musique :</label>
        <div class="switch" style="gap:0.6em;">
          <button id="music-toggle-btn" aria-label="Musique"
            style="background:none;border:none;cursor:pointer;padding:0;">
            <img id="music-toggle-img" src="assets/icons/volume-2.svg" alt="Musique activée"
              class="music-btn-img">
          </button>
          <span id="music-toggle-label">Activée</span>
        </div>
      </div>
    </div>
  </div>
  <script>
    // BTN RETOUR (natif, sinon index)
    document.addEventListener("DOMContentLoaded", function() {
      const btnBack = document.getElementById('btn-back');
      if (btnBack) {
        btnBack.addEventListener('click', function(e) {
          e.preventDefault();
          if (window.vibrateIfEnabled) window.vibrateIfEnabled(40);
          // Retour historique si possible, sinon accueil
          if (window.history.length > 1) {
            window.history.back();
          } else {
            window.location.href = "index.html";
          }
        });
      }
      // BTN PROFIL fonctionne direct via <a>, mais on peut ajouter vibration :
      const btnProfile = document.getElementById('btn-profile');
      if (btnProfile) {
        btnProfile.addEventListener('click', function() {
          if (window.vibrateIfEnabled) window.vibrateIfEnabled(30);
        });
      }
    });

    // --- TON CODE APRES ---
    // LISTE DES LANGUES + DRAPEAUX + LABELS FIXES
    const langues = [
      { code: "fr", label: "Français", flag: `<svg class="flag" viewBox="0 0 22 16"><rect width="7.33" height="16" fill="#0055a4"/><rect x="7.33" width="7.34" height="16" fill="#fff"/><rect x="14.67" width="7.33" height="16" fill="#ef4135"/></svg>` },
      { code: "en", label: "English (US)", flag: `<svg class="flag" viewBox="0 0 22 16"><rect width="22" height="16" fill="#b22234"/><g><rect width="22" height="1.23" y="1.23" fill="#fff"/><rect width="22" height="1.23" y="3.69" fill="#fff"/><rect width="22" height="1.23" y="6.15" fill="#fff"/><rect width="22" height="1.23" y="8.61" fill="#fff"/><rect width="22" height="1.23" y="11.07" fill="#fff"/><rect width="22" height="1.23" y="13.53" fill="#fff"/></g><rect width="8.8" height="7" fill="#3c3b6e"/><g fill="#fff"><circle cx="1.2" cy="1" r="0.35"/><circle cx="2.4" cy="1" r="0.35"/><circle cx="3.6" cy="1" r="0.35"/><circle cx="4.8" cy="1" r="0.35"/><circle cx="6" cy="1" r="0.35"/><circle cx="7.2" cy="1" r="0.35"/><circle cx="1.8" cy="2" r="0.35"/><circle cx="3" cy="2" r="0.35"/><circle cx="4.2" cy="2" r="0.35"/><circle cx="5.4" cy="2" r="0.35"/><circle cx="6.6" cy="2" r="0.35"/><circle cx="2.4" cy="3" r="0.35"/><circle cx="3.6" cy="3" r="0.35"/><circle cx="4.8" cy="3" r="0.35"/><circle cx="6" cy="3" r="0.35"/><circle cx="7.2" cy="3" r="0.35"/><circle cx="1.2" cy="4" r="0.35"/><circle cx="2.4" cy="4" r="0.35"/><circle cx="3.6" cy="4" r="0.35"/><circle cx="4.8" cy="4" r="0.35"/><circle cx="6" cy="4" r="0.35"/><circle cx="1.8" cy="5" r="0.35"/><circle cx="3" cy="5" r="0.35"/><circle cx="4.2" cy="5" r="0.35"/><circle cx="5.4" cy="5" r="0.35"/><circle cx="6.6" cy="5" r="0.35"/><circle cx="2.4" cy="6" r="0.35"/><circle cx="3.6" cy="6" r="0.35"/><circle cx="4.8" cy="6" r="0.35"/><circle cx="6" cy="6" r="0.35"/><circle cx="7.2" cy="6" r="0.35"/></g></svg>` },
      { code: "de", label: "Deutsch", flag: `<svg class="flag" viewBox="0 0 22 16"><rect width="22" height="5.33" fill="#000"/><rect y="5.33" width="22" height="5.33" fill="#dd0000"/><rect y="10.67" width="22" height="5.33" fill="#ffce00"/></svg>` },
      { code: "it", label: "Italiano", flag: `<svg class="flag" viewBox="0 0 22 16"><rect width="7.33" height="16" fill="#009246"/><rect x="7.33" width="7.34" height="16" fill="#fff"/><rect x="14.67" width="7.33" height="16" fill="#ce2b37"/></svg>` },
      { code: "es", label: "Español", flag: `<svg class="flag" viewBox="0 0 22 16"><rect width="22" height="16" fill="#aa151b"/><rect y="4" width="22" height="8" fill="#f1bf00"/></svg>` },
      { code: "pt", label: "Português", flag: `<svg class="flag" viewBox="0 0 22 16"><rect width="8" height="16" fill="#00874B"/><rect x="8" width="14" height="16" fill="#FF0000"/><circle cx="9.5" cy="8" r="3.3" fill="#fff" stroke="#FFD700" stroke-width="1"/><rect x="8.6" y="5.5" width="1.8" height="5" fill="#00874B" stroke="#FFD700" stroke-width="0.5"/><circle cx="9.5" cy="8" r="1.2" fill="#00874B" stroke="#FFD700" stroke-width="0.4"/></svg>` },
      { code: "ptbr", label: "Português (BR)", flag: `<svg class="flag" viewBox="0 0 22 16"><rect width="22" height="16" fill="#3eae47"/><ellipse cx="11" cy="8" rx="8" ry="6" fill="#ffcc29"/><circle cx="11" cy="8" r="4" fill="#3e4095"/><path d="M8.3 8.4a3 3 0 0 1 5.4 0" stroke="#fff" stroke-width=".8" fill="none"/><text x="11" y="10.5" font-size="3.3" fill="#fff" text-anchor="middle" alignment-baseline="middle" font-family="Arial">BR</text></svg>` },
      { code: "ar", label: "العربية", flag: `<svg class="flag" viewBox="0 0 22 16"><rect width="22" height="16" fill="#fff"/><rect width="22" height="8" y="0" fill="#198754"/><polygon points="5,8 13,4 13,12" fill="#fff"/><circle cx="16" cy="8" r="3" fill="#198754"/></svg>` },
      { code: "idn", label: "Bahasa Indonesia", flag: `<svg class="flag" viewBox="0 0 22 16"><rect width="22" height="8" y="0" fill="#ff0000"/><rect width="22" height="8" y="8" fill="#fff"/></svg>` },
      { code: "ja", label: "日本語", flag: `<svg class="flag" viewBox="0 0 22 16"><rect width="22" height="16" fill="#fff"/><circle cx="11" cy="8" r="4" fill="#bc002d"/></svg>` },
      { code: "ko", label: "한국어", flag: `<svg class="flag" viewBox="0 0 22 16"><rect width="22" height="16" fill="#fff"/><circle cx="11" cy="8" r="4" fill="#003478"/><circle cx="11" cy="8" r="2.5" fill="#c60c30"/></svg>` },
    ];
    const langueSelect = document.getElementById("langue-select");
    let selectedLang = localStorage.getItem("langue") || "fr";
    langues.forEach(l => {
      const opt = document.createElement('div');
      opt.className = 'lang-option' + (l.code === selectedLang ? ' selected' : '');
      opt.innerHTML = l.flag + '<span style="margin-left:0.35em;">' + l.label + '</span>';
      opt.onclick = () => {
        localStorage.setItem("langue", l.code);
        document.querySelectorAll('.lang-option').forEach(o => o.classList.remove('selected'));
        opt.classList.add('selected');
        if (window.setLang) window.setLang(l.code);
        location.reload();
      };
      langueSelect.appendChild(opt);
    });

    // Vibrations
    const vibrateToggle = document.getElementById("vibrate-toggle");
    const vibrateLabel = document.getElementById("vibrate-label");
    vibrateToggle.checked = localStorage.getItem("vibrateEnabled") !== "false";
    vibrateLabel.setAttribute("data-i18n", vibrateToggle.checked ? "settings.vibrate.on" : "settings.vibrate.off");
    vibrateLabel.textContent = vibrateToggle.checked ? "Activées" : "Désactivées";
    vibrateToggle.addEventListener("change", () => {
      localStorage.setItem("vibrateEnabled", vibrateToggle.checked ? "true" : "false");
      vibrateLabel.setAttribute("data-i18n", vibrateToggle.checked ? "settings.vibrate.on" : "settings.vibrate.off");
      vibrateLabel.textContent = vibrateToggle.checked ? "Activées" : "Désactivées";
    });

    // Helper globale
    window.vibrateIfEnabled = async function (ms = 60) {
      const vibrateEnabled = localStorage.getItem("vibrateEnabled") !== "false";
      if (!vibrateEnabled) return;
      if (window.Capacitor && window.Capacitor.isNativePlatform && window.Capacitor.Plugins?.Haptics) {
        await window.Capacitor.Plugins.Haptics.vibrate({ duration: ms });
      } else if ("vibrate" in navigator) {
        navigator.vibrate(ms);
      }
    }

    // Publicités i18n
    const adsToggle = document.getElementById("ads-toggle");
    const adsLabel = document.getElementById("ads-label");
    adsToggle.checked = localStorage.getItem("adsEnabled") !== "false";
    adsLabel.setAttribute("data-i18n", adsToggle.checked ? "settings.ads.on" : "settings.ads.off");
    adsLabel.textContent = adsToggle.checked ? "Activées" : "Désactivées";
    adsToggle.addEventListener("change", () => {
      localStorage.setItem("adsEnabled", adsToggle.checked ? "true" : "false");
      adsLabel.setAttribute("data-i18n", adsToggle.checked ? "settings.ads.on" : "settings.ads.off");
      adsLabel.textContent = adsToggle.checked ? "Activées" : "Désactivées";
      window.userConsent = adsToggle.checked ? "accept" : "refuse";
      location.reload();
    });

    // Pièce fantôme
    const ghostToggle = document.getElementById("ghost-toggle");
    const ghostLabel = document.getElementById("ghost-label");
    ghostToggle.checked = localStorage.getItem("ghostPiece") !== "false";
    ghostLabel.setAttribute("data-i18n", ghostToggle.checked ? "settings.ghost.on" : "settings.ghost.off");
    ghostLabel.textContent = ghostToggle.checked ? "Activée" : "Désactivée";
    ghostToggle.addEventListener("change", () => {
      localStorage.setItem("ghostPiece", ghostToggle.checked ? "true" : "false");
      ghostLabel.setAttribute("data-i18n", ghostToggle.checked ? "settings.ghost.on" : "settings.ghost.off");
      ghostLabel.textContent = ghostToggle.checked ? "Activée" : "Désactivée";
    });

    // ----- MUSIQUE (DÉFINITIF) -----
    const musicToggleBtn = document.getElementById("music-toggle-btn");
    const musicToggleImg = document.getElementById("music-toggle-img");
    const musicToggleLabel = document.getElementById("music-toggle-label");

    let alwaysMuteMusic = localStorage.getItem('alwaysMuteMusic') === 'true';

    function updateMusicToggleUI() {
      if (alwaysMuteMusic) {
        musicToggleImg.src = "assets/icons/volume-x.svg";
        musicToggleImg.alt = "Musique coupée";
        musicToggleLabel.textContent = "Coupée";
      } else {
        musicToggleImg.src = "assets/icons/volume-2.svg";
        musicToggleImg.alt = "Musique activée";
        musicToggleLabel.textContent = "Activée";
      }
    }
    updateMusicToggleUI();

    musicToggleBtn.addEventListener("click", () => {
      alwaysMuteMusic = !alwaysMuteMusic;
      localStorage.setItem('alwaysMuteMusic', alwaysMuteMusic ? 'true' : 'false');
      updateMusicToggleUI();
      location.reload();
    });

    window.addEventListener("DOMContentLoaded", () => {
      if (window.i18nTranslateAll) window.i18nTranslateAll();
    });
  </script>
  <script src="js/i18n.js"></script>
  <script src="js/pub.js"></script>
</body>
</html>
